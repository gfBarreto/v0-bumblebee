#####################################################################
# Barra Led´s
#####################################################################
[gcode_macro LED_AQUECIMENTO_DINAMICO]
description: LED do toolhead muda dinamicamente conforme aquecimento e fica verde ao atingir temperatura
gcode:
    {% set led = "extrusora_led" %}
    {% set bed_target = printer.heater_bed.target|float %}
    {% set hotend_target = printer.extruder.target|float %}
    {% set update_interval = 0.5 %}   # segundos entre atualizações
    {% set steps = 100 %}             # número máximo de atualizações por fase

    # === AQUECIMENTO DA CAMA ===
    M117 Aguardando cama atingir {bed_target}°C
    {% set concluido = False %}
    {% for i in range(steps) if not concluido %}
        {% set temp = printer.heater_bed.temperature|float %}
        {% set t = (temp / bed_target) if bed_target > 0 else 0 %}
        {% if t > 1.0 %}
            {% set t = 1.0 %}
        {% endif %}

        # Interpolação direta (azul → vermelho)
        {% set r = t %}
        {% set g = 0.3 * (1.0 - t) %}
        {% set b = 1.0 - t %}
        {% set brilho = 0.2 + (t * 0.8) %}

        SET_LED LED={led} RED={r * brilho} GREEN={g * brilho} BLUE={b * brilho} WHITE=0
        G4 P{update_interval * 1000}

        {% if temp >= bed_target - 0.5 %}
            {% set concluido = True %}
        {% endif %}
    {% endfor %}

    # Cama atingiu o alvo → verde fixo
    SET_LED LED={led} RED=0.0 GREEN=1.0 BLUE=0.0 WHITE=0
    M117 Cama pronta!
    G4 P1500

    # === AQUECIMENTO DO BICO ===
    M117 Aguardando bico atingir {hotend_target}°C
    {% set concluido = False %}
    {% for i in range(steps) if not concluido %}
        {% set temp = printer.extruder.temperature|float %}
        {% set t = (temp / hotend_target) if hotend_target > 0 else 0 %}
        {% if t > 1.0 %}
            {% set t = 1.0 %}
        {% endif %}

        {% set r = t %}
        {% set g = 0.3 * (1.0 - t) %}
        {% set b = 1.0 - t %}
        {% set brilho = 0.2 + (t * 0.8) %}

        SET_LED LED={led} RED={r * brilho} GREEN={g * brilho} BLUE={b * brilho} WHITE=0
        G4 P{update_interval * 1000}

        {% if temp >= hotend_target - 0.5 %}
            {% set concluido = True %}
        {% endif %}
    {% endfor %}

    # Bico atingiu o alvo → verde fixo
    SET_LED LED={led} RED=0.0 GREEN=1.0 BLUE=0.0 WHITE=0
    M117 Bico pronto!
    G4 P2000

    # Final: verde permanente
    SET_LED LED={led} RED=0.0 GREEN=1.0 BLUE=0.0 WHITE=0
    M117 Pronto para imprimir!


[gcode_macro Liga_BarraLed]
description: "Liga a barra de LED com brilho ajustável"
variable_brightness: 0.5  # valor padrão, pode ser 0.0 a 1.0
gcode:
  SET_PIN PIN=barra_leds VALUE={brightness}

[gcode_macro Desliga_BarraLed]
description: "Desliga a barra de LED"
gcode:
  SET_PIN PIN=barra_leds VALUE=0



#####################################################################
# Neopixel
#####################################################################
[neopixel extrusora_led]
pin: head:PD3
chain_count: 1
color_order: GRBW
initial_red: 0.7
initial_green: 0.6
initial_blue: 0.0
initial_white: 0.0

[gcode_macro LIGA_LED]
  gcode:
    #Liga os led´s do toolhead
    SET_LED LED=left_rgb RED=0.1 GREEN=0.1 BLUE=0.1
    SET_LED LED=right_rgb RED=0.1 GREEN=0.1 BLUE=0.1

[gcode_macro DESLIGA_LED]
  gcode:
    #Liga os led´s do toolhead
    SET_LED LED=left_rgb RED=0.0 GREEN=0.0 BLUE=0.0
    SET_LED LED=right_rgb RED=0.0 GREEN=0.0 BLUE=0.0

[gcode_macro PISCA_ALTERNADO]
gcode:
    # Liga os LEDs em vermelho
    SET_LED LED=extrusora_led RED=0.9 GREEN=0.0 BLUE=0.0 WHITE=0
    G4 P500  # Espera 500ms
    # Liga os LEDs em azul
    SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=1 WHITE=0
    G4 P500  # Espera 500ms
    # Repetir várias vezes
    SET_LED LED=extrusora_led RED=0.9 GREEN=0 BLUE=0 WHITE=0
    G4 P500
    SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=1 WHITE=0
    G4 P500

[gcode_macro PISCA_FINAL]
gcode:
    # Liga os LEDs em vermelho
    SET_LED LED=extrusora_led RED=0.05 GREEN=0.95 BLUE=0.05 WHITE=0
    G4 P500  # Espera 500ms
    # Liga os LEDs em azul
    SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=1 WHITE=0
    G4 P500  # Espera 500ms
    # Repetir várias vezes
    SET_LED LED=extrusora_led RED=0.05 GREEN=0.95 BLUE=0.05 WHITE=0
    G4 P500
    SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=1 WHITE=0
    G4 P500

[gcode_macro LOGO_VERMELHO]
gcode:
  SET_LED LED=extrusora_led RED=0.9 GREEN=0.0 BLUE=0.0 WHITE=0

[gcode_macro LOGO_VERDE]
gcode:
  SET_LED LED=extrusora_led RED=0.05 GREEN=0.95 BLUE=0.05 WHITE=0

[gcode_macro LOGO_AZUL]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=1 WHITE=0

[gcode_macro LOGO_AMARELO]
gcode:
  SET_LED LED=extrusora_led RED=0.95 GREEN=0.95 BLUE=0.05 WHITE=0

[gcode_macro LOGO_MAGENTA]
gcode:
  SET_LED LED=extrusora_led RED=0.95 GREEN=0.05 BLUE=0.95 WHITE=0

[gcode_macro LOGO_ESVERDAEDO]
gcode:
  SET_LED LED=extrusora_led RED=0.05 GREEN=0.95 BLUE=0.95 WHITE=0

[gcode_macro LOGO_LARANJA]
gcode:
  SET_LED LED=extrusora_led RED=0.95 GREEN=0.45 BLUE=0.05 WHITE=0

[gcode_macro LOGO_LIMA]
gcode:
  SET_LED LED=extrusora_led RED=0.45 GREEN=0.95 BLUE=0.05 WHITE=0

[gcode_macro LOGO_ROXO]
gcode:
  SET_LED LED=extrusora_led RED=0.45 GREEN=0.05 BLUE=0.95 WHITE=0

[gcode_macro LOGO_OFF]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=0

[gcode_macro LOGO_BRANCO]
gcode:
  SET_LED LED=extrusora_led RED=0.1 GREEN=0.1 BLUE=0.1 WHITE=0

#####################################################################
# Stealth Bed Front Lighting - Kirigami Bed
#####################################################################

#[neopixel extrusora_led]
## RGB light installed on bed mount
#pin: gpio24
#chain_count: 1
#color_order: GRBW
#initial_RED: 0.0
#initial_GREEN: 0.0
#initial_BLUE: 0.0
#initial_WHITE: 0.0

#####################################################################
#   Picobilical LED Connectors
#####################################################################

## Neopixel 1 - Frame PCB
#[neopixel rgb1]
#pin: umb:gpio1
#chain_count: 1
#color_order: GRB
#initial_RED: 0.3
#initial_GREEN: 0.3
#initial_BLUE: 0.3

## Neopixel 2 - Frame PCB
#[neopixel rgb2]
#pin: umb:gpio7
#chain_count: 1
#color_order: GRB
#initial_RED: 0.3
#initial_GREEN: 0.3
#initial_BLUE: 0.3

#[gcode_macro LIGHT_ON]
#variable_delay_ms: 50
#variable_led_count: 8
#gcode:
#  {% for led_index in range(1, led_count + 1) %}
#    SET_LED LED=rgb1 RED=0.8 GREEN=0.8 BLUE=0.99 INDEX={led_index}
#    SET_LED LED=rgb2 RED=0.8 GREEN=0.8 BLUE=0.99 INDEX={led_index}
#    G4 P{delay_ms}
#  {% endfor %}
  
#[gcode_macro LIGHT_OFF]
#gcode:
#  SET_LED LED=rgb1 RED=0 GREEN=0 BLUE=0
