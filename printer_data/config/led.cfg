#####################################################################
# Barra Led´s
#####################################################################
[gcode_macro LED_AQUECIMENTO_DINAMICO]
description: LED do toolhead acompanha dinamicamente o aquecimento da cama e do bico, sem interferir
gcode:
    {% set led = "extrusora_led" %}
    {% set update_interval = 0.5 %}   # segundos entre atualizações
    {% set steps = 200 %}             # número máximo de loops por fase
    {% set margem = 1.0 %}            # tolerância de temperatura para considerar "atingido"

    # === AQUECIMENTO DA CAMA ===
    {% set bed_target = printer.heater_bed.target|float %}
    {% if bed_target > 0 %}
        M117 Acompanhando aquecimento da cama ({bed_target}°C)
        {% set concluido = False %}
        {% for i in range(steps) if not concluido %}
            {% set temp = printer.heater_bed.temperature|float %}
            {% set t = (temp / bed_target) if bed_target > 0 else 0 %}
            {% if t > 1.0 %}{% set t = 1.0 %}{% endif %}

            # Interpolação direta (azul → vermelho)
            {% set r = t %}
            {% set g = 0.3 * (1.0 - t) %}
            {% set b = 1.0 - t %}
            {% set brilho = 0.2 + (t * 0.8) %}

            SET_LED LED={led} RED={r * brilho} GREEN={g * brilho} BLUE={b * brilho} WHITE=0
            G4 P{update_interval * 1000}

            {% if temp >= bed_target - margem %}
                {% set concluido = True %}
            {% endif %}
        {% endfor %}
        # Cama pronta → verde fixo
        SET_LED LED={led} RED=0.0 GREEN=1.0 BLUE=0.0 WHITE=0
        M117 Cama pronta!
        G4 P1000
    {% endif %}

    # === AQUECIMENTO DO BICO ===
    {% set hotend_target = printer.extruder.target|float %}
    {% if hotend_target > 0 %}
        M117 Acompanhando aquecimento do bico ({hotend_target}°C)
        {% set concluido = False %}
        {% for i in range(steps) if not concluido %}
            {% set temp = printer.extruder.temperature|float %}
            {% set t = (temp / hotend_target) if hotend_target > 0 else 0 %}
            {% if t > 1.0 %}{% set t = 1.0 %}{% endif %}

            {% set r = t %}
            {% set g = 0.3 * (1.0 - t) %}
            {% set b = 1.0 - t %}
            {% set brilho = 0.2 + (t * 0.8) %}

            SET_LED LED={led} RED={r * brilho} GREEN={g * brilho} BLUE={b * brilho} WHITE=0
            G4 P{update_interval * 1000}

            {% if temp >= hotend_target - margem %}
                {% set concluido = True %}
            {% endif %}
        {% endfor %}
        # Bico pronto → verde fixo
        SET_LED LED={led} RED=0.0 GREEN=1.0 BLUE=0.0 WHITE=0
        M117 Bico pronto!
        G4 P2000
    {% endif %}

    # === Final ===
    SET_LED LED={led} RED=0.0 GREEN=1.0 BLUE=0.0 WHITE=0
    M117 Pronto para imprimir!



[gcode_macro Liga_BarraLed]
description: "Liga a barra de LED com brilho ajustável"
variable_brightness: 0.5  # valor padrão, pode ser 0.0 a 1.0
gcode:
  SET_PIN PIN=barra_leds VALUE={brightness}

[gcode_macro Desliga_BarraLed]
description: "Desliga a barra de LED"
gcode:
  SET_PIN PIN=barra_leds VALUE=0



#####################################################################
# Neopixel
#####################################################################
[neopixel extrusora_led]
pin: head:PD3
chain_count: 1
color_order: GRBW
initial_red: 0.7
initial_green: 0.6
initial_blue: 0.0
initial_white: 0.0

[gcode_macro LIGA_LED]
  gcode:
    #Liga os led´s do toolhead
    SET_LED LED=left_rgb RED=0.1 GREEN=0.1 BLUE=0.1
    SET_LED LED=right_rgb RED=0.1 GREEN=0.1 BLUE=0.1

[gcode_macro DESLIGA_LED]
  gcode:
    #Liga os led´s do toolhead
    SET_LED LED=left_rgb RED=0.0 GREEN=0.0 BLUE=0.0
    SET_LED LED=right_rgb RED=0.0 GREEN=0.0 BLUE=0.0

[gcode_macro LED_AZUL]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=1 WHITE=0

[gcode_macro LED_VERMELHO]
gcode:
  SET_LED LED=extrusora_led RED=1 GREEN=0 BLUE=0 WHITE=0

[gcode_macro LED_VERDE]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=1 BLUE=0 WHITE=0

[gcode_macro LED_BRANCO]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=1

[gcode_macro LED_LARANJA]
gcode:
  SET_LED LED=extrusora_led RED=1 GREEN=0.35 BLUE=0 WHITE=0

[gcode_macro LED_OFF]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=0

[gcode_macro LED_FADE]
description: Fade entre duas cores no extrusora_led (SR/SG/SB/SW -> ER/EG/EB/EW)
gcode:
  {% set steps = params.STEPS|default(30)|int %}
  {% set dt_ms = params.DT|default(25)|int %}

  {% set sr = params.SR|default(0)|float %}
  {% set sg = params.SG|default(0)|float %}
  {% set sb = params.SB|default(0)|float %}
  {% set sw = params.SW|default(0)|float %}

  {% set er = params.ER|default(0)|float %}
  {% set eg = params.EG|default(0)|float %}
  {% set eb = params.EB|default(0)|float %}
  {% set ew = params.EW|default(0)|float %}

  {% for i in range(0, steps+1) %}
    {% set t = i / steps %}
    SET_LED LED=extrusora_led \
      RED={sr + (er - sr) * t} \
      GREEN={sg + (eg - sg) * t} \
      BLUE={sb + (eb - sb) * t} \
      WHITE={sw + (ew - sw) * t}
    G4 P{dt_ms}
  {% endfor %}

[gcode_macro LED_RESPIRAR_BRANCO]
description: Respiração branca (1 ciclo)
gcode:
  LED_FADE SW=0.00 EW=1.00 STEPS=50 DT=15
  LED_FADE SW=1.00 EW=0.00 STEPS=50 DT=15

[gcode_macro LED_FADE_AZUL_VERDE]
description: Azul -> Verde (1 vez)
gcode:
  LED_FADE SB=1 EG=1 STEPS=40 DT=20

[gcode_macro LED_FADE_VERMELHO_AZUL]
description: Vermelho -> Azul (1 vez)
gcode:
  LED_FADE SR=1 EB=1 STEPS=45 DT=20

[gcode_macro LED_FRIO_QUENTE]
description: Azul -> Laranja -> Vermelho (1 vez)
gcode:
  LED_FADE SB=1 ER=1 EG=0.35 STEPS=50 DT=15
  LED_FADE SR=1 SG=0.35 ER=1 EG=0 STEPS=25 DT=15

[gcode_macro LED_CICLO_SUAVE]
description: Azul -> Verde -> Laranja -> Vermelho -> Azul (1 volta)
gcode:
  LED_FADE SB=1 EG=1 STEPS=35 DT=20
  LED_FADE SG=1 ER=1 EG=0.35 STEPS=35 DT=20
  LED_FADE SR=1 SG=0.35 ER=1 EG=0 STEPS=35 DT=20
  LED_FADE SR=1 EB=1 STEPS=35 DT=20

[gcode_macro LED_MODO]
description: Define modo de efeito contínuo: OFF|RESPIRA|CICLO|ALERTA
variable_mode: "OFF"
gcode:
  {% set m = params.MODE|default("OFF")|upper %}
  SET_GCODE_VARIABLE MACRO=LED_MODO VARIABLE=mode VALUE='"{m}"'
  UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.05

[delayed_gcode LED_TICK]
gcode:
  {% set mode = printer["gcode_macro LED_MODO"].mode|string %}

  {% if mode == "OFF" %}
    # não reagenda

  {% elif mode == "RESPIRA" %}
    LED_RESPIRAR_BRANCO
    UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.01

  {% elif mode == "CICLO" %}
    LED_CICLO_SUAVE
    UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.01

  {% elif mode == "ALERTA" %}
    # pisca vermelho rápido enquanto estiver em ALERTA
    SET_LED LED=extrusora_led RED=1 GREEN=0 BLUE=0 WHITE=0
    G4 P120
    SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=0
    G4 P120
    UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.01

  {% else %}
    # modo desconhecido -> desliga
    SET_GCODE_VARIABLE MACRO=LED_MODO VARIABLE=mode VALUE='"OFF"'
  {% endif %}

[gcode_macro LED_LOOP_OFF]
gcode:
  LED_MODO MODE=OFF

[gcode_macro LED_LOOP_RESPIRA]
gcode:
  LED_MODO MODE=RESPIRA

[gcode_macro LED_LOOP_CICLO]
gcode:
  LED_MODO MODE=CICLO

[gcode_macro LED_LOOP_ALERTA]
gcode:
  LED_MODO MODE=ALERTA

