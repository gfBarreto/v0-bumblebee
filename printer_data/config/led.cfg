#####################################################################
# led.cfg  (DECLARAÇÕES + MACROS) - AJUSTADO
#
# Ajustes feitos:
#  1) Mantido extrusora_led como GRBW (confirmado funcionando com WHITE).
#  2) Corrigido/organizado: defaults, clamp (0..1), round, e DT/steps mínimos.
#  3) Adicionado LED_LOOP_CICLO (você tinha citado antes; faltava aqui).
#  4) Melhorado o loop: evita reentrância simples usando "lock" (opcional, leve).
#  5) Mantido TESTE_EFEITO_EXTRUSORA.
#
# OBS: você PRECISA trocar <PIN_DA_BARRA> pelo pino real da barra.
#####################################################################

#####################################################################
# Declarações (devices)
#####################################################################

[output_pin barra_leds]
pin: expander:PA3
pwm: True
value: 0.0
shutdown_value: 0.0
cycle_time: 0.010

[neopixel display_led]
pin: PC6
chain_count: 1
color_order: GRB
initial_red: 0.0
initial_green: 0.0
initial_blue: 0.0

[neopixel extrusora_led]
pin: head:PD3
chain_count: 1
color_order: GRBW
initial_red: 0.0
initial_green: 0.0
initial_blue: 0.0
initial_white: 0.0


#####################################################################
# Barra Led´s (macros)
#####################################################################
[gcode_macro Liga_BarraLed]
description: "Liga a barra de LED com brilho ajustável"
variable_brightness: 0.5  # 0.0 a 1.0
gcode:
  {% set b = params.BRIGHTNESS|default(printer["gcode_macro Liga_BarraLed"].brightness)|float %}
  {% if b < 0 %}{% set b = 0 %}{% endif %}
  {% if b > 1 %}{% set b = 1 %}{% endif %}
  SET_PIN PIN=barra_leds VALUE={b|round(3)}

[gcode_macro Desliga_BarraLed]
description: "Desliga a barra de LED"
gcode:
  SET_PIN PIN=barra_leds VALUE=0


#####################################################################
# LEDS - Macros (extrusora + display)
#####################################################################

[gcode_macro LEDS_OFF]
description: Desliga extrusora + display (não mexe na barra)
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=0
  SET_LED LED=display_led RED=0 GREEN=0 BLUE=0

[gcode_macro LEDS_ALL_OFF]
description: Desliga extrusora + display + barra
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=0
  SET_LED LED=display_led RED=0 GREEN=0 BLUE=0
  SET_PIN PIN=barra_leds VALUE=0


#####################################################################
# Testes
#####################################################################
[gcode_macro TESTE_EFEITO_EXTRUSORA]
gcode:
  LED_EXTRUSORA_FADE SR=0 SG=0 SB=0 SW=0 ER=0 EG=0 EB=1 EW=0 STEPS=20 DT=10
  LED_EXTRUSORA_FADE SR=0 SG=0 SB=1 SW=0 ER=0 EG=0 EB=0 EW=0 STEPS=20 DT=10


#####################################################################
# Cores sólidas (EXTRUSORA)
#####################################################################
[gcode_macro LED_EXTRUSORA_AZUL]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=1 WHITE=0

[gcode_macro LED_EXTRUSORA_VERMELHO]
gcode:
  SET_LED LED=extrusora_led RED=1 GREEN=0 BLUE=0 WHITE=0

[gcode_macro LED_EXTRUSORA_VERDE]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=1 BLUE=0 WHITE=0

[gcode_macro LED_EXTRUSORA_BRANCO]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=1

[gcode_macro LED_EXTRUSORA_LARANJA]
gcode:
  SET_LED LED=extrusora_led RED=1 GREEN=0.35 BLUE=0 WHITE=0

[gcode_macro LED_EXTRUSORA_OFF]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=0


#####################################################################
# Cores sólidas (DISPLAY - GRB)
#####################################################################
[gcode_macro LED_DISPLAY_AZUL]
gcode:
  SET_LED LED=display_led RED=0 GREEN=0 BLUE=1

[gcode_macro LED_DISPLAY_VERMELHO]
gcode:
  SET_LED LED=display_led RED=1 GREEN=0 BLUE=0

[gcode_macro LED_DISPLAY_VERDE]
gcode:
  SET_LED LED=display_led RED=0 GREEN=1 BLUE=0

[gcode_macro LED_DISPLAY_BRANCO]
gcode:
  SET_LED LED=display_led RED=1 GREEN=1 BLUE=1

[gcode_macro LED_DISPLAY_LARANJA]
gcode:
  SET_LED LED=display_led RED=1 GREEN=0.25 BLUE=0

[gcode_macro LED_DISPLAY_OFF]
gcode:
  SET_LED LED=display_led RED=0 GREEN=0 BLUE=0


#####################################################################
# Status (extrusora + display)
#####################################################################
[gcode_macro LED_STATUS_AQUECENDO]
gcode:
  SET_LED LED=extrusora_led RED=1 GREEN=0.35 BLUE=0 WHITE=0
  SET_LED LED=display_led RED=1 GREEN=0.25 BLUE=0

[gcode_macro LED_STATUS_PRINT]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=1 BLUE=0 WHITE=0
  SET_LED LED=display_led RED=0 GREEN=1 BLUE=0

[gcode_macro LED_STATUS_PAUSE]
gcode:
  SET_LED LED=extrusora_led RED=1 GREEN=0.35 BLUE=0 WHITE=0
  SET_LED LED=display_led RED=1 GREEN=0.25 BLUE=0

[gcode_macro LED_STATUS_RESUME]
gcode:
  SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=1
  SET_LED LED=display_led RED=1 GREEN=1 BLUE=1

[gcode_macro LED_STATUS_ERRO]
gcode:
  SET_LED LED=extrusora_led RED=1 GREEN=0 BLUE=0 WHITE=0
  SET_LED LED=display_led RED=1 GREEN=0 BLUE=0


#####################################################################
# Fade genérico (extrusora GRBW)
#####################################################################
[gcode_macro LED_EXTRUSORA_FADE]
description: "Fade extrusora_led (SR/SG/SB/SW -> ER/EG/EB/EW)"
gcode:
  {% set steps = params.STEPS|default(30)|int %}
  {% set dt_ms = params.DT|default(25)|int %}

  # sanidade
  {% if steps < 1 %}{% set steps = 1 %}{% endif %}
  {% if dt_ms < 0 %}{% set dt_ms = 0 %}{% endif %}

  {% set sr = params.SR|default(0)|float %}
  {% set sg = params.SG|default(0)|float %}
  {% set sb = params.SB|default(0)|float %}
  {% set sw = params.SW|default(0)|float %}

  {% set er = params.ER|default(0)|float %}
  {% set eg = params.EG|default(0)|float %}
  {% set eb = params.EB|default(0)|float %}
  {% set ew = params.EW|default(0)|float %}

  {% for i in range(0, steps+1) %}
    {% set t = i / steps %}
    {% set r = (sr + (er - sr) * t) %}
    {% set g = (sg + (eg - sg) * t) %}
    {% set b = (sb + (eb - sb) * t) %}
    {% set w = (sw + (ew - sw) * t) %}

    # clamp 0..1
    {% if r < 0 %}{% set r = 0 %}{% endif %}{% if r > 1 %}{% set r = 1 %}{% endif %}
    {% if g < 0 %}{% set g = 0 %}{% endif %}{% if g > 1 %}{% set g = 1 %}{% endif %}
    {% if b < 0 %}{% set b = 0 %}{% endif %}{% if b > 1 %}{% set b = 1 %}{% endif %}
    {% if w < 0 %}{% set w = 0 %}{% endif %}{% if w > 1 %}{% set w = 1 %}{% endif %}

    SET_LED LED=extrusora_led RED={r|round(3)} GREEN={g|round(3)} BLUE={b|round(3)} WHITE={w|round(3)}
    G4 P{dt_ms}
  {% endfor %}


#####################################################################
# Fade genérico (display GRB)
#####################################################################
[gcode_macro LED_DISPLAY_FADE]
description: "Fade display_led (SR/SG/SB -> ER/EG/EB)"
gcode:
  {% set steps = params.STEPS|default(30)|int %}
  {% set dt_ms = params.DT|default(25)|int %}

  {% if steps < 1 %}{% set steps = 1 %}{% endif %}
  {% if dt_ms < 0 %}{% set dt_ms = 0 %}{% endif %}

  {% set sr = params.SR|default(0)|float %}
  {% set sg = params.SG|default(0)|float %}
  {% set sb = params.SB|default(0)|float %}
  {% set er = params.ER|default(0)|float %}
  {% set eg = params.EG|default(0)|float %}
  {% set eb = params.EB|default(0)|float %}

  {% for i in range(0, steps+1) %}
    {% set t = i / steps %}
    {% set r = (sr + (er - sr) * t) %}
    {% set g = (sg + (eg - sg) * t) %}
    {% set b = (sb + (eb - sb) * t) %}

    {% if r < 0 %}{% set r = 0 %}{% endif %}{% if r > 1 %}{% set r = 1 %}{% endif %}
    {% if g < 0 %}{% set g = 0 %}{% endif %}{% if g > 1 %}{% set g = 1 %}{% endif %}
    {% if b < 0 %}{% set b = 0 %}{% endif %}{% if b > 1 %}{% set b = 1 %}{% endif %}

    SET_LED LED=display_led RED={r|round(3)} GREEN={g|round(3)} BLUE={b|round(3)}
    G4 P{dt_ms}
  {% endfor %}


#####################################################################
# Efeitos (1 ciclo)
#####################################################################
[gcode_macro LED_EXTRUSORA_RESPIRAR_BRANCO]
gcode:
  LED_EXTRUSORA_FADE SR=0 SG=0 SB=0 SW=0.00 ER=0 EG=0 EB=0 EW=1.00 STEPS=50 DT=15
  LED_EXTRUSORA_FADE SR=0 SG=0 SB=0 SW=1.00 ER=0 EG=0 EB=0 EW=0.00 STEPS=50 DT=15

[gcode_macro LED_DISPLAY_RESPIRAR_BRANCO]
gcode:
  LED_DISPLAY_FADE SR=0 SG=0 SB=0 ER=1 EG=1 EB=1 STEPS=50 DT=15
  LED_DISPLAY_FADE SR=1 SG=1 SB=1 ER=0 EG=0 EB=0 STEPS=50 DT=15

[gcode_macro LED_EXTRUSORA_CICLO_SUAVE]
gcode:
  LED_EXTRUSORA_FADE SR=0 SG=0 SB=1 SW=0 ER=0 EG=1 EB=0 EW=0 STEPS=35 DT=20
  LED_EXTRUSORA_FADE SR=0 SG=1 SB=0 SW=0 ER=1 EG=0.35 EB=0 EW=0 STEPS=35 DT=20
  LED_EXTRUSORA_FADE SR=1 SG=0.35 SB=0 SW=0 ER=1 EG=0 EB=0 EW=0 STEPS=35 DT=20
  LED_EXTRUSORA_FADE SR=1 SG=0 SB=0 SW=0 ER=0 EG=0 EB=1 EW=0 STEPS=35 DT=20

[gcode_macro LED_DISPLAY_CICLO_SUAVE]
gcode:
  LED_DISPLAY_FADE SR=0 SG=0 SB=1 ER=0 EG=1 EB=0 STEPS=35 DT=20
  LED_DISPLAY_FADE SR=0 SG=1 SB=0 ER=1 EG=0.25 EB=0 STEPS=35 DT=20
  LED_DISPLAY_FADE SR=1 SG=0.25 SB=0 ER=1 EG=0 EB=0 STEPS=35 DT=20
  LED_DISPLAY_FADE SR=1 SG=0 SB=0 ER=0 EG=0 EB=1 STEPS=35 DT=20


#####################################################################
# Loop
#####################################################################
[gcode_macro LED_LOOP_MODO]
description: "Define modo contínuo: OFF|RESPIRA|CICLO|ALERTA"
variable_mode: "OFF"
variable_lock: 0
gcode:
  {% set m = params.MODE|default("OFF")|upper %}
  SET_GCODE_VARIABLE MACRO=LED_LOOP_MODO VARIABLE=mode VALUE='"{m}"'
  UPDATE_DELAYED_GCODE ID=LED_LOOP_TICK DURATION=0.05

[delayed_gcode LED_LOOP_TICK]
gcode:
  {% set mode = printer["gcode_macro LED_LOOP_MODO"].mode|string %}
  {% set lock = printer["gcode_macro LED_LOOP_MODO"].lock|int %}

  # evita reentrar caso algum tick tenha sido disparado em paralelo
  {% if lock != 0 %}
    UPDATE_DELAYED_GCODE ID=LED_LOOP_TICK DURATION=0.25
  {% else %}
    SET_GCODE_VARIABLE MACRO=LED_LOOP_MODO VARIABLE=lock VALUE=1

    {% if mode == "OFF" %}
      # não reagenda

    {% elif mode == "RESPIRA" %}
      LED_EXTRUSORA_RESPIRAR_BRANCO
      LED_DISPLAY_RESPIRAR_BRANCO
      UPDATE_DELAYED_GCODE ID=LED_LOOP_TICK DURATION=0.01

    {% elif mode == "CICLO" %}
      LED_EXTRUSORA_CICLO_SUAVE
      LED_DISPLAY_CICLO_SUAVE
      UPDATE_DELAYED_GCODE ID=LED_LOOP_TICK DURATION=0.01

    {% elif mode == "ALERTA" %}
      SET_LED LED=extrusora_led RED=1 GREEN=0 BLUE=0 WHITE=0
      SET_LED LED=display_led RED=1 GREEN=0 BLUE=0
      G4 P120
      SET_LED LED=extrusora_led RED=0 GREEN=0 BLUE=0 WHITE=0
      SET_LED LED=display_led RED=0 GREEN=0 BLUE=0
      G4 P120
      UPDATE_DELAYED_GCODE ID=LED_LOOP_TICK DURATION=0.01

    {% else %}
      SET_GCODE_VARIABLE MACRO=LED_LOOP_MODO VARIABLE=mode VALUE='"OFF"'
    {% endif %}

    SET_GCODE_VARIABLE MACRO=LED_LOOP_MODO VARIABLE=lock VALUE=0
  {% endif %}

[gcode_macro LED_LOOP_OFF]
gcode:
  LED_LOOP_MODO MODE=OFF

[gcode_macro LED_LOOP_RESPIRA]
gcode:
  LED_LOOP_MODO MODE=RESPIRA

[gcode_macro LED_LOOP_CICLO]
gcode:
  LED_LOOP_MODO MODE=CICLO

[gcode_macro LED_LOOP_ALERTA]
gcode:
  LED_LOOP_MODO MODE=ALERTA

#####################################################################
# Aquecimento com progressão de cor (frio -> quente) baseado em temp
# (robusto: usa extrusor ativo e não quebra com MMU/toolhead)
#####################################################################
[gcode_macro LED_HEAT_PROGRESS]
description: "Progresso 0.0-1.0: azul->vermelho (display e extrusora)"
gcode:
  {% set p = params.P|float %}
  {% if p < 0.0 %}{% set p = 0.0 %}{% endif %}
  {% if p > 1.0 %}{% set p = 1.0 %}{% endif %}

  {% set r = p %}
  {% set g = 0.0 %}
  {% set b = 1.0 - p %}

  SET_LED LED=extrusora_led RED={r} GREEN={g} BLUE={b} WHITE=0
  SET_LED LED=display_led   RED={r} GREEN={g} BLUE={b}



[gcode_macro LED_HEAT_TRACK_START]
description: "Inicia acompanhamento de aquecimento (mesa+bico) com LEDs"
variable_active: 0
variable_target_bed: 0
variable_target_hotend: 0
gcode:
  {% set tb = params.BED|default(0)|float %}
  {% set th = params.HOTEND|default(0)|float %}

  SET_GCODE_VARIABLE MACRO=LED_HEAT_TRACK_START VARIABLE=target_bed VALUE={tb}
  SET_GCODE_VARIABLE MACRO=LED_HEAT_TRACK_START VARIABLE=target_hotend VALUE={th}
  SET_GCODE_VARIABLE MACRO=LED_HEAT_TRACK_START VARIABLE=active VALUE=1

  {% set msg = '"Track ON (BED=%.1f, HOTEND=%.1f)"' % (tb, th) %}
  RESPOND PREFIX="LED_HEAT" MSG={msg}

  UPDATE_DELAYED_GCODE ID=LED_HEAT_TRACK_TICK DURATION=0.05



[delayed_gcode LED_HEAT_TRACK_TICK]
gcode:
  {% set active = printer["gcode_macro LED_HEAT_TRACK_START"].active|int %}
  {% if active == 0 %}
    # não reagenda
  {% else %}
    {% set tb = printer["gcode_macro LED_HEAT_TRACK_START"].target_bed|float %}
    {% set th = printer["gcode_macro LED_HEAT_TRACK_START"].target_hotend|float %}

    {% set bed_temp = printer.heater_bed.temperature|float %}

    # extrusor ativo (robusto)
    {% set ex_name = printer.toolhead.extruder|string %}
    {% if ex_name == "" %}
      {% set hot_temp = 0.0 %}
    {% else %}
      {% set hot_temp = printer[ex_name].temperature|float %}
    {% endif %}

    {% set tb_eff = tb if tb > 1 else 1 %}
    {% set th_eff = th if th > 1 else 1 %}

    {% set pb = bed_temp / tb_eff %}
    {% set ph = hot_temp / th_eff %}
    {% if pb < 0 %}{% set pb = 0 %}{% endif %}{% if pb > 1 %}{% set pb = 1 %}{% endif %}
    {% if ph < 0 %}{% set ph = 0 %}{% endif %}{% if ph > 1 %}{% set ph = 1 %}{% endif %}

    {% set p = pb if pb < ph else ph %}

    LED_HEAT_PROGRESS P={p}

    # Debug leve (se quiser ver no console; comente se incomodar)
    {% set msg = '"bed=%.1f/%.1f hot=%.1f/%.1f p=%.2f"' % (bed_temp, tb, hot_temp, th, p) %}
    RESPOND PREFIX="LED_HEAT" MSG={msg}

    {% if (bed_temp >= tb - 0.5) and ((ex_name == "") or (hot_temp >= th - 0.5)) %}
      SET_GCODE_VARIABLE MACRO=LED_HEAT_TRACK_START VARIABLE=active VALUE=0
      RESPOND PREFIX="LED_HEAT" MSG="Targets atingidos, parando loop."
    {% else %}
      UPDATE_DELAYED_GCODE ID=LED_HEAT_TRACK_TICK DURATION=0.5
    {% endif %}
  {% endif %}

[gcode_macro LED_TEST_PROGRESS]
gcode:
  LED_HEAT_PROGRESS P=0.0
  G4 S2
  LED_HEAT_PROGRESS P=0.5
  G4 S2
  LED_HEAT_PROGRESS P=1.0
  G4 S2
